{
  "Name": "ファイル削除処理",
  "Enabled": true,
  "Triggers": [
    {
      "$type": "Forguncy.SaveLoad.PostRequestTriggerSaveData, ServerDesignerCommon",
      "Permission": {
        "PermissionData": {
          "$type": "Forguncy.RbacPermission.Core.Impl.ServerCommand.ServerCommandPermissionData, Forguncy.RbacPermission.Core",
          "permissionResource": {
            "$type": "Forguncy.RbacPermission.Core.Impl.ServerCommand.ServerCommandPermissionResource, Forguncy.RbacPermission.Core"
          },
          "permissionBindings": [
            {
              "$type": "Forguncy.RbacPermission.Core.Impl.ServerCommand.ServerCommandPermissionBinding, Forguncy.RbacPermission.Core",
              "roleNames": [
                "FGC_LoginUser"
              ]
            }
          ]
        }
      },
      "Parameters": [
        {
          "Name": "P_添付ID",
          "DataValidationInfo": {}
        }
      ]
    }
  ],
  "Commands": [
    {
      "$type": "Forguncy.Model.ServerTransactionCommand, ServerDesignerCommon",
      "CommandList": [
        {
          "$type": "Forguncy.Model.Commands.SetParameterCommand, ServerDesignerCommon",
          "ParameterName": "添付情報",
          "TableValue": {
            "TableName": "t_object_attachment",
            "TableValueType": 1,
            "BindingInfos": [
              {
                "GUID": "db587302-754e-4b33-ac28-7e03e5db0adf",
                "BindingInfo": {
                  "TableName": "t_object_attachment",
                  "ColumnName": "file_path_name",
                  "GUID": "ea86211e-c635-4ded-8c24-ea42c8def9f9"
                },
                "ColumnName": "ファイルパス名"
              },
              {
                "GUID": "1ac6089c-1939-4df1-b8a7-50a3d94a5044",
                "BindingInfo": {
                  "TableName": "t_object_attachment",
                  "ColumnName": "save_file_name",
                  "GUID": "f0aa07ad-e655-4ed1-8bb7-6ed9361af4bf"
                },
                "ColumnName": "保存ファイル名"
              },
              {
                "GUID": "61feb352-1772-4037-ad63-90ff7631fe44",
                "BindingInfo": {
                  "TableName": "t_object_attachment",
                  "ColumnName": "file_attribute_id",
                  "GUID": "d0f594dc-ee62-4bc7-8d4c-85b5e11ecf8f",
                  "RelationBinding": {
                    "RelatedTable": "m_file_attirbute",
                    "RelatedColumn": "file_attribute_id",
                    "DisplayColumn": "applicant_company_authority"
                  }
                },
                "ColumnName": "申込事業者権限"
              },
              {
                "GUID": "5623bdfd-9ab7-4494-849f-478eb33b5777",
                "BindingInfo": {
                  "TableName": "t_object_attachment",
                  "ColumnName": "object_order_id",
                  "GUID": "39796581-b728-41a8-927e-6e04d23109be"
                },
                "ColumnName": "申込ID"
              },
              {
                "GUID": "35a1b436-1986-4f61-b36d-38ca7df8fd36",
                "BindingInfo": {
                  "TableName": "t_object_attachment",
                  "ColumnName": "object_product_id",
                  "GUID": "fded8b4e-353c-480d-92e2-42cf0e4f3a7a"
                },
                "ColumnName": "物件商品ID"
              },
              {
                "GUID": "f76b1b64-80b4-486b-b293-b0703143b181",
                "BindingInfo": {
                  "TableName": "t_object_attachment",
                  "ColumnName": "file_attribute_id",
                  "GUID": "48c0849c-c47e-461d-9248-f96ba36354b2"
                },
                "ColumnName": "ファイル属性ID"
              },
              {
                "GUID": "7b63cd77-d56a-47d5-8629-7cf9f5b2ee47",
                "BindingInfo": {
                  "TableName": "t_object_attachment",
                  "ColumnName": "construction_estimate_id",
                  "GUID": "e8b6aa03-4b0c-4f7f-816a-1be3fc86728e"
                },
                "ColumnName": "工事見積ID"
              }
            ],
            "SqlCondition": {
              "$type": "ForguncyDataAccess.GeneralCESqlCondition, ForguncyDataAccess",
              "ColumnBindingInfo": {
                "TableName": "t_object_attachment",
                "ColumnName": "attachment_id",
                "GUID": "c433fc57-3dee-4c3d-bb18-644563ba3ca8"
              },
              "Value": {
                "$type": "Forguncy.Model.FormulaReferObject, ServerDesignerCommon",
                "SerializeProperty": "=P_添付ID"
              }
            }
          },
          "ID": "ab03778ddb1a457ca0017ec7af0016e1"
        },
        {
          "$type": "Forguncy.Model.Commands.SetParameterCommand, ServerDesignerCommon",
          "ParameterName": "削除フォルダ名",
          "ParameterValue": "trashed",
          "ID": "e61fd35d5b6b49d290f9e32e44a31432"
        },
        {
          "$type": "Forguncy.Model.Commands.SetParameterCommand, ServerDesignerCommon",
          "ParameterName": "削除フォルダパス名",
          "ParameterValue": {
            "$type": "Forguncy.Model.FormulaReferObject, ServerDesignerCommon",
            "SerializeProperty": "=添付情報.ファイルパス名&削除フォルダ名&\"\\\""
          },
          "ID": "8c7bfc73341d4b7f8a8561072b6d7ebf"
        },
        {
          "$type": "OperateFilesCommand.CreateFolderCommand, OperateFilesCommand",
          "FolderPath": {
            "$type": "Forguncy.Model.FormulaReferObject, ServerDesignerCommon",
            "SerializeProperty": "=削除フォルダパス名"
          }
        },
        {
          "$type": "Forguncy.Model.UpdateDataTableCommand, ServerDesignerCommon",
          "TableName": "t_object_attachment",
          "ShowConfirm": false,
          "RowsToUpdate": 1,
          "RowsToUpdateCondition": {
            "$type": "ForguncyDataAccess.GeneralCESqlCondition, ForguncyDataAccess",
            "ColumnBindingInfo": {
              "TableName": "t_object_attachment",
              "ColumnName": "attachment_id",
              "GUID": "13b57e80-fedc-4010-b508-567fd847ab90"
            },
            "Value": {
              "$type": "Forguncy.Model.FormulaReferObject, ServerDesignerCommon",
              "SerializeProperty": "=P_添付ID"
            }
          },
          "UpdateBindingValues": [
            {
              "BindingInfo": {
                "TableName": "t_object_attachment",
                "ColumnName": "file_path_name",
                "GUID": "a080273f-e7e5-4641-878c-e10b81a4b75b"
              },
              "Value": {
                "$type": "Forguncy.Model.FormulaReferObject, ServerDesignerCommon",
                "SerializeProperty": "=削除フォルダパス名"
              }
            },
            {
              "BindingInfo": {
                "TableName": "t_object_attachment",
                "ColumnName": "active_flg",
                "GUID": "ce2dc33a-2752-41e1-b925-18e2dc18eaa6"
              },
              "Value": "0"
            },
            {
              "BindingInfo": {
                "TableName": "t_object_attachment",
                "ColumnName": "delete_user_id",
                "GUID": "ce638602-1dad-452a-a1ad-1c8720d06f7b"
              },
              "Value": "%CurrentUser.user_id%"
            },
            {
              "BindingInfo": {
                "TableName": "t_object_attachment",
                "ColumnName": "deleted_datetime",
                "GUID": "fcd0ed70-6726-4777-aa06-4d2fc2bfb277"
              },
              "Value": {
                "$type": "Forguncy.Model.FormulaReferObject, ServerDesignerCommon",
                "SerializeProperty": "=NOW()"
              }
            }
          ]
        },
        {
          "$type": "Forguncy.Model.Commands.SetParameterCommand, ServerDesignerCommon",
          "ParameterName": "対象ファイルフルパス名",
          "ParameterValue": {
            "$type": "Forguncy.Model.FormulaReferObject, ServerDesignerCommon",
            "SerializeProperty": "=添付情報.ファイルパス名&添付情報.保存ファイル名"
          },
          "ID": "08e35ceb6b144a7ab0f592fbc7dbeb59"
        },
        {
          "$type": "Forguncy.Model.Commands.SetParameterCommand, ServerDesignerCommon",
          "ParameterName": "DropBoxフルパス名",
          "ParameterValue": {
            "$type": "Forguncy.Model.FormulaReferObject, ServerDesignerCommon",
            "SerializeProperty": "=SUBSTITUTE(対象ファイルフルパス名,\"C:\\MP-Cloud\\Dropbox\",\"\")"
          },
          "ID": "4507187fae7a462aa3260983e60f3c64"
        },
        {
          "$type": "Forguncy.Model.Commands.SetParameterCommand, ServerDesignerCommon",
          "ParameterName": "DropBox削除フォルダパス名",
          "ParameterValue": {
            "$type": "Forguncy.Model.FormulaReferObject, ServerDesignerCommon",
            "SerializeProperty": "=SUBSTITUTE(削除フォルダパス名,\"C:\\MP-Cloud\\Dropbox\",\"\")"
          },
          "ID": "f97486114e0f429197e5c619ac1e9266"
        },
        {
          "$type": "OperateFilesCommand.GetFileInformation, OperateFilesCommand",
          "FilePath": {
            "$type": "Forguncy.Model.FormulaReferObject, ServerDesignerCommon",
            "SerializeProperty": "=対象ファイルフルパス名"
          },
          "FileInfomationType": 5,
          "ToParameterName": "ファイル有無"
        },
        {
          "$type": "Forguncy.Model.ConditionCommand, ServerDesignerCommon",
          "ConditionAndCommandPairList": [
            {
              "Condition": {
                "$type": "Forguncy.Model.IfCondition, ServerDesignerCommon",
                "param": {
                  "$type": "Forguncy.Model.IfConditionServerSiteParam, ServerDesignerCommon",
                  "ParamObject": {
                    "$type": "Forguncy.Model.FormulaReferObject, ServerDesignerCommon",
                    "SerializeProperty": "=ファイル有無"
                  }
                },
                "value": "False"
              },
              "CommandList": [
                {
                  "$type": "Forguncy.Model.ReturnCommand, ServerDesignerCommon",
                  "ErrorCode": "100",
                  "Message": "対象ファイルが存在しませんでした"
                }
              ],
              "ID": "b9af4c01-3e58-4b44-95c6-7ab9bb74a11b"
            }
          ]
        },
        {
          "$type": "Forguncy.Model.CatchExceptionCommand, ServerDesignerCommon",
          "TryCommandPart": {
            "CommandList": [
              {
                "$type": "OperateFilesCommand.CloudStorage.MoveFileCommand, OperateFilesCommand",
                "FilePath": {
                  "$type": "Forguncy.Model.FormulaReferObject, ServerDesignerCommon",
                  "SerializeProperty": "=DropBoxフルパス名"
                },
                "TargetFolderPath": {
                  "$type": "Forguncy.Model.FormulaReferObject, ServerDesignerCommon",
                  "SerializeProperty": "=DropBox削除フォルダパス名"
                },
                "Type": "DropboxStrage"
              }
            ]
          },
          "CatchCommandPart": {
            "CommandList": [
              {
                "$type": "OperateFilesCommand.MoveFileCommand, OperateFilesCommand",
                "FilePath": {
                  "$type": "Forguncy.Model.FormulaReferObject, ServerDesignerCommon",
                  "SerializeProperty": "=対象ファイルフルパス名"
                },
                "TargetFolderPath": {
                  "$type": "Forguncy.Model.FormulaReferObject, ServerDesignerCommon",
                  "SerializeProperty": "=削除フォルダパス名"
                }
              }
            ]
          },
          "FinallyCommandPart": {
            "CommandList": [
              {
                "$type": "Forguncy.Model.ConditionCommand, ServerDesignerCommon",
                "ConditionAndCommandPairList": [
                  {
                    "Condition": {
                      "$type": "ForguncyDataAccess.RelationSqlCondition, ForguncyDataAccess",
                      "SubConditions": [
                        {
                          "$type": "Forguncy.Model.IfCondition, ServerDesignerCommon",
                          "param": {
                            "$type": "Forguncy.Model.IfConditionServerSiteParam, ServerDesignerCommon",
                            "ParamObject": {
                              "$type": "Forguncy.Model.FormulaReferObject, ServerDesignerCommon",
                              "SerializeProperty": "=添付情報.ファイル属性ID"
                            }
                          },
                          "value": "5"
                        },
                        {
                          "$type": "Forguncy.Model.IfCondition, ServerDesignerCommon",
                          "param": {
                            "$type": "Forguncy.Model.IfConditionServerSiteParam, ServerDesignerCommon",
                            "ParamObject": {
                              "$type": "Forguncy.Model.FormulaReferObject, ServerDesignerCommon",
                              "SerializeProperty": "=添付情報.物件商品ID"
                            }
                          },
                          "value": "%Null%",
                          "compareType": 1
                        }
                      ]
                    },
                    "CommandList": [
                      {
                        "$type": "Forguncy.Model.Commands.SetParameterCommand, ServerDesignerCommon",
                        "ParameterName": "発注書添付カウント",
                        "TableValue": {
                          "TableName": "t_object_attachment",
                          "TableValueType": 3,
                          "SqlCondition": {
                            "$type": "ForguncyDataAccess.RelationSqlCondition, ForguncyDataAccess",
                            "SubConditions": [
                              {
                                "$type": "ForguncyDataAccess.GeneralCESqlCondition, ForguncyDataAccess",
                                "ColumnBindingInfo": {
                                  "TableName": "t_object_attachment",
                                  "ColumnName": "object_order_id",
                                  "GUID": "48d57f91-4ec8-4566-b9f1-e27d95913ed7"
                                },
                                "Value": {
                                  "$type": "Forguncy.Model.FormulaReferObject, ServerDesignerCommon",
                                  "SerializeProperty": "=添付情報.申込ID"
                                }
                              },
                              {
                                "$type": "ForguncyDataAccess.GeneralCESqlCondition, ForguncyDataAccess",
                                "ColumnBindingInfo": {
                                  "TableName": "t_object_attachment",
                                  "ColumnName": "object_product_id",
                                  "GUID": "45f25adf-39de-414b-b175-e7769ae2306f"
                                },
                                "Value": {
                                  "$type": "Forguncy.Model.FormulaReferObject, ServerDesignerCommon",
                                  "SerializeProperty": "=添付情報.物件商品ID"
                                }
                              },
                              {
                                "$type": "ForguncyDataAccess.GeneralCESqlCondition, ForguncyDataAccess",
                                "ColumnBindingInfo": {
                                  "TableName": "t_object_attachment",
                                  "ColumnName": "file_attribute_id",
                                  "GUID": "e5767a2d-4a91-4a2a-8d7f-a716a93e3181"
                                },
                                "Value": "5"
                              },
                              {
                                "$type": "ForguncyDataAccess.GeneralCESqlCondition, ForguncyDataAccess",
                                "ColumnBindingInfo": {
                                  "TableName": "t_object_attachment",
                                  "ColumnName": "active_flg",
                                  "GUID": "7f11b198-2463-416f-bca5-82874ad959f1"
                                },
                                "Value": "1"
                              }
                            ]
                          },
                          "NullFormulaValueQueryPolicy": 0
                        },
                        "ID": "28978458b06349a0bf2c8c6915a9a891"
                      },
                      {
                        "$type": "Forguncy.Model.UpdateDataTableCommand, ServerDesignerCommon",
                        "TableName": "t_object_product",
                        "ShowConfirm": false,
                        "RowsToUpdate": 1,
                        "RowsToUpdateCondition": {
                          "$type": "ForguncyDataAccess.GeneralCESqlCondition, ForguncyDataAccess",
                          "ColumnBindingInfo": {
                            "TableName": "t_object_product",
                            "ColumnName": "object_product_id",
                            "GUID": "afccd70f-7329-41f3-8f4a-b369e96e479f"
                          },
                          "Value": {
                            "$type": "Forguncy.Model.FormulaReferObject, ServerDesignerCommon",
                            "SerializeProperty": "=添付情報.物件商品ID"
                          }
                        },
                        "UpdateBindingValues": [
                          {
                            "BindingInfo": {
                              "TableName": "t_object_product",
                              "ColumnName": "purchase_attached_file_count",
                              "GUID": "a534a3f6-4d33-48e7-9cb5-4443ae198893"
                            },
                            "Value": {
                              "$type": "Forguncy.Model.FormulaReferObject, ServerDesignerCommon",
                              "SerializeProperty": "=発注書添付カウント"
                            }
                          }
                        ],
                        "Comments": "発注書添付カウントを更新"
                      }
                    ],
                    "ID": "d8900d86-9182-41c9-8c48-9ca33b3b1bbf"
                  }
                ]
              },
              {
                "$type": "Forguncy.Model.ConditionCommand, ServerDesignerCommon",
                "ConditionAndCommandPairList": [
                  {
                    "Condition": {
                      "$type": "Forguncy.Model.IfCondition, ServerDesignerCommon",
                      "param": {
                        "$type": "Forguncy.Model.IfConditionServerSiteParam, ServerDesignerCommon",
                        "ParamObject": {
                          "$type": "Forguncy.Model.FormulaReferObject, ServerDesignerCommon",
                          "SerializeProperty": "=添付情報.工事見積ID"
                        }
                      },
                      "value": "%Null%",
                      "compareType": 1
                    },
                    "CommandList": [
                      {
                        "$type": "Forguncy.Model.Commands.SetParameterCommand, ServerDesignerCommon",
                        "ParameterName": "工事見積添付カウント",
                        "TableValue": {
                          "TableName": "t_object_attachment",
                          "TableValueType": 3,
                          "SqlCondition": {
                            "$type": "ForguncyDataAccess.RelationSqlCondition, ForguncyDataAccess",
                            "SubConditions": [
                              {
                                "$type": "ForguncyDataAccess.GeneralCESqlCondition, ForguncyDataAccess",
                                "ColumnBindingInfo": {
                                  "TableName": "t_object_attachment",
                                  "ColumnName": "object_order_id",
                                  "GUID": "3f2df1b3-a063-4e50-b6d9-d6659251e9f9"
                                },
                                "Value": {
                                  "$type": "Forguncy.Model.FormulaReferObject, ServerDesignerCommon",
                                  "SerializeProperty": "=添付情報.申込ID"
                                }
                              },
                              {
                                "$type": "ForguncyDataAccess.GeneralCESqlCondition, ForguncyDataAccess",
                                "ColumnBindingInfo": {
                                  "TableName": "t_object_attachment",
                                  "ColumnName": "construction_estimate_id",
                                  "GUID": "98003a99-411a-4bff-9def-cf8c7bfb1dac"
                                },
                                "Value": {
                                  "$type": "Forguncy.Model.FormulaReferObject, ServerDesignerCommon",
                                  "SerializeProperty": "=添付情報.工事見積ID"
                                }
                              },
                              {
                                "$type": "ForguncyDataAccess.GeneralCESqlCondition, ForguncyDataAccess",
                                "ColumnBindingInfo": {
                                  "TableName": "t_object_attachment",
                                  "ColumnName": "active_flg",
                                  "GUID": "6f7a359a-b04f-4ef5-90b0-cf480f8d1afc"
                                },
                                "Value": "1"
                              }
                            ]
                          },
                          "NullFormulaValueQueryPolicy": 0
                        },
                        "ID": "aa0c70ac3aeb4b12bcff32d1b2062378"
                      },
                      {
                        "$type": "Forguncy.Model.UpdateDataTableCommand, ServerDesignerCommon",
                        "TableName": "t_object_construction_estimate",
                        "ShowConfirm": false,
                        "RowsToUpdate": 1,
                        "RowsToUpdateCondition": {
                          "$type": "ForguncyDataAccess.GeneralCESqlCondition, ForguncyDataAccess",
                          "ColumnBindingInfo": {
                            "TableName": "t_object_construction_estimate",
                            "ColumnName": "construction_estimate_id",
                            "GUID": "67225677-b872-4999-9884-e406a600d646"
                          },
                          "Value": {
                            "$type": "Forguncy.Model.FormulaReferObject, ServerDesignerCommon",
                            "SerializeProperty": "=添付情報.工事見積ID"
                          }
                        },
                        "UpdateBindingValues": [
                          {
                            "BindingInfo": {
                              "TableName": "t_object_construction_estimate",
                              "ColumnName": "estimate_file_count",
                              "GUID": "a40acb75-ef4a-4c76-85f8-56485e31ae40"
                            },
                            "Value": {
                              "$type": "Forguncy.Model.FormulaReferObject, ServerDesignerCommon",
                              "SerializeProperty": "=工事見積添付カウント"
                            }
                          }
                        ]
                      }
                    ],
                    "ID": "e916c38c-8a29-4090-be0e-b4f6093a3f26"
                  }
                ]
              },
              {
                "$type": "Forguncy.Model.Commands.SetParameterCommand, ServerDesignerCommon",
                "ParameterName": "添付関連付け情報",
                "TableValue": {
                  "TableName": "t_object_attachment_relation",
                  "BindingInfos": [
                    {
                      "GUID": "2f2f4c29-3e7c-4a8c-b5c3-e833646c8470",
                      "BindingInfo": {
                        "TableName": "t_object_attachment_relation",
                        "ColumnName": "object_id",
                        "GUID": "ab0acfa7-31d1-4b23-af13-afc97098cb7e"
                      },
                      "ColumnName": "物件ID"
                    }
                  ],
                  "SqlCondition": {
                    "$type": "ForguncyDataAccess.GeneralCESqlCondition, ForguncyDataAccess",
                    "ColumnBindingInfo": {
                      "TableName": "t_object_attachment_relation",
                      "ColumnName": "attachment_id",
                      "GUID": "30a81b28-edac-4b9a-a5ac-056a3d4702c0"
                    },
                    "Value": {
                      "$type": "Forguncy.Model.FormulaReferObject, ServerDesignerCommon",
                      "SerializeProperty": "=P_添付ID"
                    }
                  },
                  "NullFormulaValueQueryPolicy": 0
                },
                "ID": "a8b747f89659425fab59a67b871611b2"
              },
              {
                "$type": "Forguncy.Model.LoopCommand, ServerDesignerCommon",
                "LoopInfo": {
                  "$type": "Forguncy.Model.CountLoopInfo, ServerDesignerCommon",
                  "LoopCount": {
                    "$type": "Forguncy.Model.FormulaReferObject, ServerDesignerCommon",
                    "SerializeProperty": "=添付関連付け情報"
                  },
                  "LoopItemParamName": "Item添付関連付け"
                },
                "CommandList": [
                  {
                    "$type": "Forguncy.Model.RequestServerCommand, ServerDesignerCommon",
                    "ServerCommandName": "ファイル数更新処理",
                    "Parameters": [
                      {
                        "$type": "Forguncy.Model.RequestServerCommandObjectParam, ServerDesignerCommon",
                        "ParamName": "P_物件IDs",
                        "Value": {
                          "$type": "Forguncy.Model.FormulaReferObject, ServerDesignerCommon",
                          "SerializeProperty": "=Item添付関連付け.物件ID"
                        }
                      }
                    ],
                    "RefreshAfterFinish": true,
                    "CheckDataValidation": true
                  }
                ]
              }
            ]
          }
        }
      ]
    }
  ]
}