{
  "Name": "FileDownload",
  "Enabled": true,
  "Triggers": [
    {
      "$type": "Forguncy.SaveLoad.PostRequestTriggerSaveData, ServerDesignerCommon",
      "Permission": {
        "PermissionData": {
          "$type": "Forguncy.RbacPermission.Core.Impl.ServerCommand.ServerCommandPermissionData, Forguncy.RbacPermission.Core",
          "permissionResource": {
            "$type": "Forguncy.RbacPermission.Core.Impl.ServerCommand.ServerCommandPermissionResource, Forguncy.RbacPermission.Core"
          },
          "permissionBindings": [
            {
              "$type": "Forguncy.RbacPermission.Core.Impl.ServerCommand.ServerCommandPermissionBinding, Forguncy.RbacPermission.Core",
              "roleNames": [
                "FGC_Anonymous",
                "FGC_LoginUser"
              ]
            }
          ]
        }
      },
      "HttpMethod": 2,
      "Parameters": [
        {
          "Name": "id",
          "Remark": "申込ID",
          "DataValidationInfo": {}
        },
        {
          "Name": "filekey",
          "Remark": "ランダム変数",
          "DataValidationInfo": {}
        },
        {
          "Name": "type",
          "Remark": "ダウンロードリンク区分を適用する\r\n1:圧縮リンク\r\n2:ファイルリンク",
          "DataValidationInfo": {}
        }
      ]
    }
  ],
  "Commands": [
    {
      "$type": "Forguncy.Model.ConditionCommand, ServerDesignerCommon",
      "ConditionAndCommandPairList": [
        {
          "Condition": {
            "$type": "Forguncy.Model.IfCondition, ServerDesignerCommon",
            "param": {
              "$type": "Forguncy.Model.IfConditionServerSiteParam, ServerDesignerCommon",
              "ParamObject": {
                "$type": "Forguncy.Model.FormulaReferObject, ServerDesignerCommon",
                "SerializeProperty": "=type"
              }
            },
            "value": "2"
          },
          "CommandList": [
            {
              "$type": "OperateFilesCommand.GetFilesFromFolderCommand, OperateFilesCommand",
              "FolderPath": {
                "$type": "Forguncy.Model.FormulaReferObject, ServerDesignerCommon",
                "SerializeProperty": "=Download_Server_Path&filekey&\"\\\""
              },
              "ToParameterName": "downLoadFile"
            },
            {
              "$type": "Forguncy.Model.ConditionCommand, ServerDesignerCommon",
              "ConditionAndCommandPairList": [
                {
                  "Condition": {
                    "$type": "Forguncy.Model.IfCondition, ServerDesignerCommon",
                    "param": {
                      "$type": "Forguncy.Model.IfConditionServerSiteParam, ServerDesignerCommon",
                      "ParamObject": {
                        "$type": "Forguncy.Model.FormulaReferObject, ServerDesignerCommon",
                        "SerializeProperty": "=downLoadFile.Count"
                      }
                    },
                    "value": "0"
                  },
                  "CommandList": [
                    {
                      "$type": "Forguncy.Model.ReturnCommand, ServerDesignerCommon",
                      "ErrorCode": "100",
                      "Message": "ファイルは存在しませんでした。有効期間を過ぎた可能性があります。"
                    }
                  ],
                  "ID": "2085bc09-fe29-40d7-92e5-b308f65c17c1"
                }
              ]
            },
            {
              "$type": "Forguncy.Model.LoopCommand, ServerDesignerCommon",
              "LoopInfo": {
                "$type": "Forguncy.Model.CountLoopInfo, ServerDesignerCommon",
                "LoopCount": {
                  "$type": "Forguncy.Model.FormulaReferObject, ServerDesignerCommon",
                  "SerializeProperty": "=downLoadFile"
                },
                "LoopItemParamName": "filePath"
              },
              "CommandList": [
                {
                  "$type": "OperateFilesCommand.DownloadFileCommand, OperateFilesCommand",
                  "FilePath": {
                    "$type": "Forguncy.Model.FormulaReferObject, ServerDesignerCommon",
                    "SerializeProperty": "=filePath"
                  }
                },
                {
                  "$type": "Forguncy.Model.ReturnCommand, ServerDesignerCommon",
                  "ErrorCode": "0"
                }
              ]
            }
          ],
          "Comments": "ファイルリンクダウンロードの場合",
          "ID": "d54b5b51-f0e7-4a29-bdd2-22aeb6429b17"
        },
        {
          "CommandList": [
            {
              "$type": "Forguncy.Model.Commands.SetParameterCommand, ServerDesignerCommon",
              "ParameterName": "ZIP作成元パス名",
              "ParameterValue": {
                "$type": "Forguncy.Model.FormulaReferObject, ServerDesignerCommon",
                "SerializeProperty": "=Download_Server_Path&filekey&\"\\\""
              },
              "ID": "3baa7e74b1e040d1aa22b6df5718da58"
            },
            {
              "$type": "Forguncy.Model.Commands.SetParameterCommand, ServerDesignerCommon",
              "ParameterName": "ZIP作成先パス名",
              "ParameterValue": {
                "$type": "Forguncy.Model.FormulaReferObject, ServerDesignerCommon",
                "SerializeProperty": "=Export_Server_Path&\"Temp\\\"&filekey&\"\\\""
              },
              "ID": "8ae034cf21794cd98a02a42f131682a3"
            },
            {
              "$type": "Forguncy.Model.Commands.SetParameterCommand, ServerDesignerCommon",
              "ParameterName": "ZIPファイルパス名",
              "ParameterValue": {
                "$type": "Forguncy.Model.FormulaReferObject, ServerDesignerCommon",
                "SerializeProperty": "=ZIP作成先パス名&filekey&\".zip\""
              },
              "ID": "d61e17fe0e534a33ac87d16bc1db3d21"
            },
            {
              "$type": "OperateFilesCommand.GetFilesFromFolderCommand, OperateFilesCommand",
              "FolderPath": {
                "$type": "Forguncy.Model.FormulaReferObject, ServerDesignerCommon",
                "SerializeProperty": "=ZIP作成元パス名"
              },
              "ToParameterName": "downLoadFile"
            },
            {
              "$type": "Forguncy.Model.ConditionCommand, ServerDesignerCommon",
              "ConditionAndCommandPairList": [
                {
                  "Condition": {
                    "$type": "Forguncy.Model.IfCondition, ServerDesignerCommon",
                    "param": {
                      "$type": "Forguncy.Model.IfConditionServerSiteParam, ServerDesignerCommon",
                      "ParamObject": {
                        "$type": "Forguncy.Model.FormulaReferObject, ServerDesignerCommon",
                        "SerializeProperty": "=downLoadFile.Count"
                      }
                    },
                    "value": "0"
                  },
                  "CommandList": [
                    {
                      "$type": "Forguncy.Model.ReturnCommand, ServerDesignerCommon",
                      "ErrorCode": "100",
                      "Message": "ファイルは存在しませんでした。有効期間を過ぎた可能性があります。"
                    }
                  ],
                  "ID": "3937f97c-c914-41ed-af4b-e9232512c6dc"
                }
              ]
            },
            {
              "$type": "OperateFilesCommand.CreateFolderCommand, OperateFilesCommand",
              "FolderPath": {
                "$type": "Forguncy.Model.FormulaReferObject, ServerDesignerCommon",
                "SerializeProperty": "=ZIP作成先パス名"
              }
            },
            {
              "$type": "OperateFilesCommand.GetFileInformation, OperateFilesCommand",
              "FilePath": {
                "$type": "Forguncy.Model.FormulaReferObject, ServerDesignerCommon",
                "SerializeProperty": "=ZIPファイルパス名"
              },
              "FileInfomationType": 5,
              "ToParameterName": "ZIPファイル有無"
            },
            {
              "$type": "Forguncy.Model.ConditionCommand, ServerDesignerCommon",
              "ConditionAndCommandPairList": [
                {
                  "Condition": {
                    "$type": "Forguncy.Model.IfCondition, ServerDesignerCommon",
                    "param": {
                      "$type": "Forguncy.Model.IfConditionServerSiteParam, ServerDesignerCommon",
                      "ParamObject": {
                        "$type": "Forguncy.Model.FormulaReferObject, ServerDesignerCommon",
                        "SerializeProperty": "=ZIPファイル有無"
                      }
                    },
                    "value": "True"
                  },
                  "CommandList": [
                    {
                      "$type": "OperateFilesCommand.DeleteFileCommand, OperateFilesCommand",
                      "FilePath": {
                        "$type": "Forguncy.Model.FormulaReferObject, ServerDesignerCommon",
                        "SerializeProperty": "=ZIPファイルパス名"
                      }
                    }
                  ],
                  "ID": "a2c68024-4f58-44f0-9e13-30193babbf74"
                }
              ]
            },
            {
              "$type": "OperateFilesCommand.ZipFolderCommand, OperateFilesCommand",
              "FolderPath": {
                "$type": "Forguncy.Model.FormulaReferObject, ServerDesignerCommon",
                "SerializeProperty": "=ZIP作成元パス名"
              },
              "ZipfilePath": {
                "$type": "Forguncy.Model.FormulaReferObject, ServerDesignerCommon",
                "SerializeProperty": "=ZIPファイルパス名"
              }
            },
            {
              "$type": "Forguncy.Model.Commands.SetParameterCommand, ServerDesignerCommon",
              "ParameterName": "ダウンロードファイル名",
              "ID": "cf71c54b99924158a73d0f37444f11eb"
            },
            {
              "$type": "Forguncy.Model.ConditionCommand, ServerDesignerCommon",
              "ConditionAndCommandPairList": [
                {
                  "Condition": {
                    "$type": "Forguncy.Model.IfCondition, ServerDesignerCommon",
                    "param": {
                      "$type": "Forguncy.Model.IfConditionServerSiteParam, ServerDesignerCommon",
                      "ParamObject": {
                        "$type": "Forguncy.Model.FormulaReferObject, ServerDesignerCommon",
                        "SerializeProperty": "=id"
                      }
                    },
                    "value": "%Null%",
                    "compareType": 1
                  },
                  "CommandList": [
                    {
                      "$type": "Forguncy.Model.Commands.SetParameterCommand, ServerDesignerCommon",
                      "ParameterName": "申込情報",
                      "TableValue": {
                        "TableName": "t_object_order",
                        "TableValueType": 1,
                        "BindingInfos": [
                          {
                            "GUID": "a2ff356c-c0dc-456c-80f3-6cc3618f4acc",
                            "BindingInfo": {
                              "TableName": "t_object_order",
                              "ColumnName": "object_id",
                              "GUID": "7b9d5d22-dd7b-4238-9d23-050971fed935",
                              "RelationBinding": {
                                "RelatedTable": "t_object",
                                "RelatedColumn": "object_id",
                                "DisplayColumn": "物件番号"
                              }
                            },
                            "ColumnName": "物件番号"
                          },
                          {
                            "GUID": "65a9963e-cec4-48ab-8ba6-e6a259937679",
                            "BindingInfo": {
                              "TableName": "t_object_order",
                              "ColumnName": "object_id",
                              "GUID": "aa47e840-7f56-4fde-ac68-f62b02a09e6c",
                              "RelationBinding": {
                                "RelatedTable": "t_object",
                                "RelatedColumn": "object_id",
                                "DisplayColumn": "物件名"
                              }
                            },
                            "ColumnName": "物件名"
                          }
                        ],
                        "SqlCondition": {
                          "$type": "ForguncyDataAccess.GeneralCESqlCondition, ForguncyDataAccess",
                          "ColumnBindingInfo": {
                            "TableName": "t_object_order",
                            "ColumnName": "object_order_id",
                            "GUID": "ab536030-bbfd-4741-a551-625d3b36a40a"
                          },
                          "Value": {
                            "$type": "Forguncy.Model.FormulaReferObject, ServerDesignerCommon",
                            "SerializeProperty": "=id"
                          }
                        },
                        "NullFormulaValueQueryPolicy": 0
                      },
                      "ID": "fb38ed13e70549ada04416bf990e9b04"
                    },
                    {
                      "$type": "Forguncy.Model.Commands.SetParameterCommand, ServerDesignerCommon",
                      "ParameterName": "ダウンロードファイル名",
                      "ParameterValue": {
                        "$type": "Forguncy.Model.FormulaReferObject, ServerDesignerCommon",
                        "SerializeProperty": "=申込情報.物件番号&\" \"&申込情報.物件名"
                      },
                      "ID": "63150b5004e54a05a6f8bc86a9b001ce"
                    }
                  ],
                  "Comments": "id=申込IDがあれば物件番号と物件名を取得しダウンロードファイル名にする",
                  "ID": "c7873c5c-eaaa-47c4-b8c3-e3181e7730b6"
                }
              ]
            },
            {
              "$type": "OperateFilesCommand.DownloadFileCommand, OperateFilesCommand",
              "FilePath": {
                "$type": "Forguncy.Model.FormulaReferObject, ServerDesignerCommon",
                "SerializeProperty": "=ZIPファイルパス名"
              },
              "DownloadFileName": {
                "$type": "Forguncy.Model.FormulaReferObject, ServerDesignerCommon",
                "SerializeProperty": "=ダウンロードファイル名"
              }
            }
          ],
          "ID": "1f6d6a78-613b-42d0-9ea7-c7963a0550ae"
        }
      ]
    }
  ]
}